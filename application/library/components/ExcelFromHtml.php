<?php

namespace app\library\components;
use PhpOffice\PhpSpreadsheet\IOFactory;
use PhpOffice\PhpSpreadsheet\Reader\Html;
use Yii;
use yii\data\ActiveDataProvider;
use yii\db\ActiveQueryInterface;
use yii\grid\Column;
use yii\helpers\ArrayHelper;
use yii\base\Model;
use PhpOffice\PhpSpreadsheet\Spreadsheet;

/**
 * @property \PhpOffice\PhpSpreadsheet\Worksheet\Worksheet _objPHPExcelSheet
 */
class ExcelFromHtml
{
    public $properties;
    public $filename = 'excel';
    public $extension = 'xls';
    private $_objPHPExcel;
    private $_objPHPExcelWriter;

    public function renderFile($htmlStr)
    {
       // $this->init_excel_sheet();
        $this->generateBody($htmlStr);
        $this->initPHPExcelWriter('Xls');
        $writer = $this->_objPHPExcelWriter;
        $this->setHttpHeaders();
        $writer->save('php://output');
        Yii::$app->end();
    }

    public function init_excel_sheet()
    {
        $this->_objPHPExcel = new Spreadsheet();
        $creator = '';
        $title = '';
        $subject = '';
        $description = 'Excel Grid Generated By BHD extension';
        $category = '';
        $keywords = '';
        $manager = '';
        $company = 'BHD';
        $created = date("Y-m-d H:i:s");
        $lastModifiedBy = '';
        extract($this->properties);
        $this->_objPHPExcel->getProperties()
            ->setCreator($creator)
            ->setTitle($title)
            ->setSubject($subject)
            ->setDescription($description)
            ->setCategory($category)
            ->setKeywords($keywords)
            ->setManager($manager)
            ->setCompany($company)
            ->setCreated($created)
            ->setLastModifiedBy($lastModifiedBy);
        $this->_objPHPExcelSheet = $this->_objPHPExcel->getActiveSheet();
    }

    public function initPHPExcelWriter($writer)
    {
        $this->_objPHPExcelWriter = IOFactory::createWriter(
            $this->_objPHPExcel,
            $writer
        );
    }

    public function generateBody($htmlStr)
    {
        $reader = new Html();
        $this->_objPHPExcel = $reader->loadFromString($htmlStr);
//        $this->_objPHPExcel = IOFactory::createWriter($spreadsheet, 'Xls');
    }

    protected function setHttpHeaders()
    {
        header("Cache-Control: no-cache");
        header("Expires: 0");
        header("Pragma: no-cache");
        header("Content-Type: application/{$this->extension}");
        header("Content-Disposition: attachment; filename={$this->filename}.{$this->extension}");
    }
}
